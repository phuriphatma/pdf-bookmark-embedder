<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Safari Download Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #007AFF;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üì± iOS Safari PDF Test</h1>
    
    <div class="test-card">
        <h3>üß™ Test 1: Server Connectivity</h3>
        <button onclick="testServerHealth()">Test Server Health</button>
        <div id="health-log" class="log"></div>
    </div>

    <div class="test-card">
        <h3>üóÇÔ∏è Test 2: File Upload & Download</h3>
        <input type="file" id="fileInput" accept=".pdf" />
        <button onclick="testFileUpload()">Upload & Process PDF</button>
        <div id="upload-log" class="log"></div>
    </div>

    <div class="test-card">
        <h3>üì• Test 3: Download Method</h3>
        <button onclick="testDownloadMethod()">Test Download with Sample PDF</button>
        <div id="download-log" class="log"></div>
    </div>

    <script>
        const SERVER_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8081' 
            : `http://${window.location.hostname}:8081`;

        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function testServerHealth() {
            const logId = 'health-log';
            log(logId, 'üîç Testing server health...');
            
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `‚úÖ Server healthy: ${data.service} v${data.version}`);
                    log(logId, `üìö Library: ${data.library}`);
                } else {
                    log(logId, `‚ùå Server error: ${response.status}`);
                }
            } catch (error) {
                log(logId, `‚ùå Connection failed: ${error.message}`);
                log(logId, `üîó Trying: ${SERVER_URL}/health`);
            }
        }

        async function testFileUpload() {
            const logId = 'upload-log';
            const fileInput = document.getElementById('fileInput');
            
            if (!fileInput.files.length) {
                log(logId, '‚ùå Please select a PDF file first');
                return;
            }

            const file = fileInput.files[0];
            log(logId, `üìÅ Selected: ${file.name} (${file.size} bytes)`);

            try {
                const formData = new FormData();
                formData.append('pdf', file);

                log(logId, 'üì§ Uploading to server...');
                const response = await fetch(`${SERVER_URL}/embed-bookmarks`, {
                    method: 'POST',
                    body: formData
                });

                log(logId, `üì° Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    log(logId, `üìÑ Content-Type: ${contentType}`);
                    
                    if (contentType && contentType.includes('application/pdf')) {
                        const blob = await response.blob();
                        log(logId, `‚úÖ PDF received: ${blob.size} bytes`);
                        
                        // Test download
                        downloadBlob(blob, 'test_with_bookmarks.pdf', logId);
                    } else {
                        const text = await response.text();
                        log(logId, `‚ùå Unexpected response: ${text}`);
                    }
                } else {
                    const errorText = await response.text();
                    log(logId, `‚ùå Server error: ${errorText}`);
                }
            } catch (error) {
                log(logId, `‚ùå Upload failed: ${error.message}`);
            }
        }

        async function testDownloadMethod() {
            const logId = 'download-log';
            log(logId, 'üß™ Testing download method with sample data...');
            
            // Create a simple test blob
            const testData = '%PDF-1.4\\n1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj 2 0 obj<</Type/Pages/Kids[3 0 R]/Count 1>>endobj 3 0 obj<</Type/Page/Parent 2 0 R/MediaBox[0 0 612 792]>>endobj xref 0 4 0000000000 65535 f 0000000009 00000 n 0000000058 00000 n 0000000115 00000 n trailer<</Size 4/Root 1 0 R>> startxref 185 %%EOF';
            const blob = new Blob([testData], { type: 'application/pdf' });
            
            log(logId, `üìÑ Created test blob: ${blob.size} bytes`);
            downloadBlob(blob, 'test_download.pdf', logId);
        }

        function downloadBlob(blob, filename, logId) {
            try {
                log(logId, 'üì• Creating download link...');
                
                // Method 1: Standard download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                
                log(logId, 'üñ±Ô∏è Triggering download...');
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    log(logId, 'üßπ Cleaned up resources');
                }, 1000);
                
                log(logId, '‚úÖ Download should have started');
                
                // iOS Safari specific test
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    log(logId, 'üì± iOS detected - testing alternative method...');
                    
                    // Method 2: Open in new tab for iOS
                    setTimeout(() => {
                        const newUrl = URL.createObjectURL(blob);
                        window.open(newUrl, '_blank');
                        log(logId, 'üîó Opened PDF in new tab for iOS');
                    }, 2000);
                }
                
            } catch (error) {
                log(logId, `‚ùå Download failed: ${error.message}`);
            }
        }

        // Auto-test server on load
        window.addEventListener('load', () => {
            setTimeout(testServerHealth, 500);
        });
    </script>
</body>
</html>
